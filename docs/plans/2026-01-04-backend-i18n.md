# Backend i18n Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 为 Tauri 后端实现中英文双语支持，消除所有硬编码的中文字符串

**Architecture:** 使用 rust-i18n 库，通过命令参数传递语言设置，翻译文件按模块组织（security、skills、database、common）

**Tech Stack:** rust-i18n 3.x, YAML 翻译文件, Tauri 2.x

---

## Task 1: 添加 rust-i18n 依赖和基础配置

**Files:**
- Modify: `src-tauri/Cargo.toml`
- Create: `src-tauri/build.rs`
- Create: `src-tauri/src/i18n.rs`

**Step 1: 添加 rust-i18n 依赖到 Cargo.toml**

在 `src-tauri/Cargo.toml` 的 `[dependencies]` 部分末尾添加：

```toml
# 国际化
rust-i18n = "3"
```

在 `[build-dependencies]` 部分末尾添加：

```toml
rust-i18n = "3"
```

**Step 2: 创建 build.rs**

```rust
fn main() {
    // 初始化 i18n（必须在 tauri_build 之前）
    rust_i18n::i18n!("locales");

    tauri_build::build()
}
```

**Step 3: 创建 i18n 模块**

创建 `src-tauri/src/i18n.rs`：

```rust
// 初始化 i18n，设置 fallback 语言为中文
rust_i18n::i18n!("locales", fallback = "zh");

/// 辅助函数：验证 locale 参数
pub fn validate_locale(locale: &str) -> &str {
    match locale {
        "zh" | "en" => locale,
        _ => "zh", // 默认使用中文
    }
}
```

**Step 4: 在 lib.rs 中引入 i18n 模块**

在 `src-tauri/src/lib.rs` 的模块声明部分添加：

```rust
mod i18n;
```

**Step 5: 运行 cargo check 验证配置**

```bash
cd src-tauri && cargo check
```

预期：编译错误，因为 locales 目录还不存在

**Step 6: 提交**

```bash
git add src-tauri/Cargo.toml src-tauri/build.rs src-tauri/src/i18n.rs src-tauri/src/lib.rs
git commit -m "feat: add rust-i18n dependency and basic configuration"
```

---

## Task 2: 创建翻译文件结构 - Security 模块

**Files:**
- Create: `src-tauri/locales/zh/security.yml`
- Create: `src-tauri/locales/en/security.yml`

**Step 1: 创建目录结构**

```bash
mkdir -p src-tauri/locales/zh
mkdir -p src-tauri/locales/en
```

**Step 2: 创建中文安全模块翻译**

创建 `src-tauri/locales/zh/security.yml`：

```yaml
blocked_message: "⛔ 检测到严重安全威胁，已阻止安装！"
score_warning_severe: "⚠️ 此 skill 存在严重安全风险，建议不要安装"
score_warning_medium: "⚠️ 此 skill 存在中等安全风险，请谨慎使用"
no_issues: "✅ 未发现明显安全问题"

file_location: "文件: %{file}, 行 %{line}"
hard_trigger_issue: "%{rule_name} (文件: %{file}, 行 %{line}): %{description}"

recommendations:
  destructive: "包含破坏性操作（如删除文件），存在极高风险"
  remote_exec: "包含远程代码执行，存在极高风险"
  cmd_injection: "包含命令注入风险，请检查代码逻辑"
  network: "包含网络请求操作，请确认目标地址可信"
  secrets: "检测到敏感信息泄露风险（密钥、密码等）"
  persistence: "包含持久化操作（如 crontab），请谨慎"
  privilege: "包含权限提升操作，请确认必要性"
  sensitive_file: "包含敏感文件访问操作（如密钥、配置文件），请确认必要性"
```

**Step 3: 创建英文安全模块翻译**

创建 `src-tauri/locales/en/security.yml`：

```yaml
blocked_message: "⛔ Severe security threat detected, installation blocked!"
score_warning_severe: "⚠️ This skill poses severe security risks, installation not recommended"
score_warning_medium: "⚠️ This skill poses moderate security risks, use with caution"
no_issues: "✅ No obvious security issues found"

file_location: "File: %{file}, Line: %{line}"
hard_trigger_issue: "%{rule_name} (File: %{file}, Line: %{line}): %{description}"

recommendations:
  destructive: "Contains destructive operations (e.g., file deletion), extremely high risk"
  remote_exec: "Contains remote code execution, extremely high risk"
  cmd_injection: "Contains command injection risk, please review code logic"
  network: "Contains network requests, verify target addresses are trusted"
  secrets: "Sensitive information leakage risk detected (keys, passwords, etc.)"
  persistence: "Contains persistence operations (e.g., crontab), use with caution"
  privilege: "Contains privilege escalation operations, verify necessity"
  sensitive_file: "Contains sensitive file access (e.g., keys, config files), verify necessity"
```

**Step 4: 验证编译**

```bash
cd src-tauri && cargo check
```

预期：编译成功

**Step 5: 提交**

```bash
git add src-tauri/locales/
git commit -m "feat: add security module translations (zh/en)"
```

---

## Task 3: 创建翻译文件 - Common 模块

**Files:**
- Create: `src-tauri/locales/zh/common.yml`
- Create: `src-tauri/locales/en/common.yml`

**Step 1: 创建中文通用翻译**

创建 `src-tauri/locales/zh/common.yml`：

```yaml
errors:
  file_not_found: "文件未找到: %{path}"
  directory_not_exist: "目录不存在: %{path}"
  path_not_file: "路径不是文件: %{path}"
  read_failed: "读取文件失败 '%{path}': %{error}"
  scan_failed: "扫描失败 '%{path}': %{error}"
```

**Step 2: 创建英文通用翻译**

创建 `src-tauri/locales/en/common.yml`：

```yaml
errors:
  file_not_found: "File not found: %{path}"
  directory_not_exist: "Directory does not exist: %{path}"
  path_not_file: "Path is not a file: %{path}"
  read_failed: "Failed to read file '%{path}': %{error}"
  scan_failed: "Failed to scan '%{path}': %{error}"
```

**Step 3: 验证编译**

```bash
cd src-tauri && cargo check
```

**Step 4: 提交**

```bash
git add src-tauri/locales/
git commit -m "feat: add common module translations (zh/en)"
```

---

## Task 4: 重构 scanner.rs - generate_recommendations 方法

**Files:**
- Modify: `src-tauri/src/security/scanner.rs`

**Step 1: 在 scanner.rs 顶部添加 use 语句**

在 `src-tauri/src/security/scanner.rs` 的 use 语句部分添加：

```rust
use rust_i18n::t;
use crate::i18n::validate_locale;
```

**Step 2: 修改 generate_recommendations 方法签名**

找到 `generate_recommendations` 方法（约第 263 行），修改签名添加 locale 参数：

```rust
// 修改前
fn generate_recommendations(&self, matches: &[MatchResult], score: i32) -> Vec<String> {

// 修改后
fn generate_recommendations(&self, matches: &[MatchResult], score: i32, locale: &str) -> Vec<String> {
    let locale = validate_locale(locale);
```

**Step 3: 替换硬编码的中文字符串 - 硬触发部分**

在 `generate_recommendations` 方法中，找到硬触发检查部分（约第 268-276 行），替换为：

```rust
// 检查是否有硬触发规则匹配
let has_hard_trigger = matches.iter().any(|m| m.hard_trigger);
if has_hard_trigger {
    recommendations.push(t!("security.blocked_message", locale = locale).to_string());
    let hard_triggers: Vec<String> = matches.iter()
        .filter(|m| m.hard_trigger)
        .map(|m| format!("  - {}", m.description))
        .collect();
    recommendations.extend(hard_triggers);
    return recommendations;
}
```

**Step 4: 替换硬编码的中文字符串 - 分数建议部分**

找到分数建议部分（约第 278-283 行），替换为：

```rust
// 基于分数的建议
if score < 50 {
    recommendations.push(t!("security.score_warning_severe", locale = locale).to_string());
} else if score < 70 {
    recommendations.push(t!("security.score_warning_medium", locale = locale).to_string());
}
```

**Step 5: 替换硬编码的中文字符串 - 分类建议部分**

找到分类建议部分（约第 295-318 行），替换为：

```rust
if has_destructive {
    recommendations.push(t!("security.recommendations.destructive", locale = locale).to_string());
}
if has_remote_exec {
    recommendations.push(t!("security.recommendations.remote_exec", locale = locale).to_string());
}
if has_cmd_injection {
    recommendations.push(t!("security.recommendations.cmd_injection", locale = locale).to_string());
}
if has_network {
    recommendations.push(t!("security.recommendations.network", locale = locale).to_string());
}
if has_secrets {
    recommendations.push(t!("security.recommendations.secrets", locale = locale).to_string());
}
if has_persistence {
    recommendations.push(t!("security.recommendations.persistence", locale = locale).to_string());
}
if has_privilege {
    recommendations.push(t!("security.recommendations.privilege", locale = locale).to_string());
}
if has_sensitive_file_access {
    recommendations.push(t!("security.recommendations.sensitive_file", locale = locale).to_string());
}
```

**Step 6: 替换硬编码的中文字符串 - 无问题情况**

找到无问题情况（约第 320-322 行），替换为：

```rust
if recommendations.is_empty() {
    recommendations.push(t!("security.no_issues", locale = locale).to_string());
}
```

**Step 7: 验证编译（预期失败）**

```bash
cd src-tauri && cargo check
```

预期：编译错误，因为调用 `generate_recommendations` 的地方还没有传递 locale 参数

**Step 8: 提交**

```bash
git add src-tauri/src/security/scanner.rs
git commit -m "refactor: add i18n support to scanner generate_recommendations"
```

---

## Task 5: 重构 scanner.rs - scan_directory 和 scan_file 方法

**Files:**
- Modify: `src-tauri/src/security/scanner.rs`

**Step 1: 修改 scan_directory 方法签名**

找到 `scan_directory` 方法（约第 28 行），添加 locale 参数：

```rust
// 修改前
pub fn scan_directory(&self, dir_path: &str, skill_id: &str) -> Result<SecurityReport> {

// 修改后
pub fn scan_directory(&self, dir_path: &str, skill_id: &str, locale: &str) -> Result<SecurityReport> {
    let locale = validate_locale(locale);
```

**Step 2: 修改 scan_directory 中的错误消息**

找到目录验证部分（约第 33-35 行），替换为：

```rust
if !path.exists() || !path.is_dir() {
    anyhow::bail!(t!("common.errors.directory_not_exist", locale = locale, path = dir_path));
}
```

**Step 3: 修改 scan_directory 中的 hard_trigger_issues 格式化**

找到 hard_trigger_issues 格式化部分（约第 89-95 行），替换为：

```rust
if match_result.hard_trigger {
    blocked = true;
    total_hard_trigger_issues.push(
        t!("security.hard_trigger_issue",
            locale = locale,
            rule_name = &match_result.rule_name,
            file = file_name,
            line = match_result.line_number,
            description = &match_result.description
        ).to_string()
    );
}
```

**Step 4: 修改 scan_directory 中的 generate_recommendations 调用**

找到 generate_recommendations 调用（约第 119 行），添加 locale 参数：

```rust
// 修改前
let recommendations = self.generate_recommendations(&all_matches, score);

// 修改后
let recommendations = self.generate_recommendations(&all_matches, score, locale);
```

**Step 5: 修改 scan_file 方法签名**

找到 `scan_file` 方法（约第 134 行），添加 locale 参数：

```rust
// 修改前
pub fn scan_file(&self, content: &str, file_path: &str) -> Result<SecurityReport> {

// 修改后
pub fn scan_file(&self, content: &str, file_path: &str, locale: &str) -> Result<SecurityReport> {
    let locale = validate_locale(locale);
```

**Step 6: 修改 scan_file 中的 hard_trigger_issues 格式化**

找到 hard_trigger_issues 格式化部分（约第 179-181 行），替换为：

```rust
let hard_trigger_issues: Vec<String> = hard_trigger_matches.iter()
    .map(|m| t!("security.hard_trigger_issue",
        locale = locale,
        rule_name = &m.rule_name,
        file = file_path,
        line = m.line_number,
        description = &m.description
    ).to_string())
    .collect();
```

**Step 7: 修改 scan_file 中的 generate_recommendations 调用**

找到 generate_recommendations 调用（约第 188 行），添加 locale 参数：

```rust
// 修改前
let recommendations = self.generate_recommendations(&matches, score);

// 修改后
let recommendations = self.generate_recommendations(&matches, score, locale);
```

**Step 8: 验证编译（预期失败）**

```bash
cd src-tauri && cargo check
```

预期：编译错误，因为调用 scan_directory 和 scan_file 的地方还没有传递 locale

**Step 9: 提交**

```bash
git add src-tauri/src/security/scanner.rs
git commit -m "refactor: add i18n support to scanner scan methods"
```

---

## Task 6: 修改 commands/security.rs - scan_skill_archive

**Files:**
- Modify: `src-tauri/src/commands/security.rs`

**Step 1: 修改 scan_skill_archive 命令签名**

找到 `scan_skill_archive` 命令（约第 167 行），添加 locale 参数：

```rust
// 修改前
#[tauri::command]
pub async fn scan_skill_archive(
    archive_path: String,
) -> Result<SecurityReport, String> {

// 修改后
#[tauri::command]
pub async fn scan_skill_archive(
    archive_path: String,
    locale: String,
) -> Result<SecurityReport, String> {
```

**Step 2: 修改错误消息使用 i18n**

在文件顶部添加 use 语句：

```rust
use rust_i18n::t;
use crate::i18n::validate_locale;
```

找到错误处理部分（约第 174-179 行），替换为：

```rust
let locale = validate_locale(&locale);

// 验证文件存在性
let path = std::path::Path::new(&archive_path);
if !path.exists() {
    return Err(t!("common.errors.file_not_found", locale = locale, path = &archive_path).to_string());
}
if !path.is_file() {
    return Err(t!("common.errors.path_not_file", locale = locale, path = &archive_path).to_string());
}
```

**Step 3: 修改 scan_file 调用**

找到 scan_file 调用（约第 182-186 行），添加 locale 参数：

```rust
// 读取文件内容
let content = std::fs::read_to_string(path)
    .map_err(|e| t!("common.errors.read_failed",
        locale = locale,
        path = &archive_path,
        error = e.to_string()
    ).to_string())?;

let report = scanner.scan_file(&content, &archive_path, &locale)
    .map_err(|e| t!("common.errors.scan_failed",
        locale = locale,
        path = &archive_path,
        error = e.to_string()
    ).to_string())?;
```

**Step 4: 验证编译**

```bash
cd src-tauri && cargo check
```

预期：可能还有其他命令的编译错误

**Step 5: 提交**

```bash
git add src-tauri/src/commands/security.rs
git commit -m "refactor: add i18n support to scan_skill_archive command"
```

---

## Task 7: 修改 commands/security.rs - scan_all_installed_skills

**Files:**
- Modify: `src-tauri/src/commands/security.rs`

**Step 1: 修改 scan_all_installed_skills 命令签名**

找到 `scan_all_installed_skills` 命令（约第 11 行），添加 locale 参数：

```rust
// 修改前
#[tauri::command]
pub async fn scan_all_installed_skills(
    state: State<'_, AppState>,
) -> Result<Vec<SkillScanResult>, String> {

// 修改后
#[tauri::command]
pub async fn scan_all_installed_skills(
    state: State<'_, AppState>,
    locale: String,
) -> Result<Vec<SkillScanResult>, String> {
    let locale = validate_locale(&locale);
```

**Step 2: 修改 scan_directory 调用**

找到 scan_directory 调用（约第 33-36 行），添加 locale 参数：

```rust
match scanner.scan_directory(
    path.to_str().unwrap_or(""),
    &skill.id,
    &locale
) {
```

**Step 3: 验证编译**

```bash
cd src-tauri && cargo check
```

**Step 4: 提交**

```bash
git add src-tauri/src/commands/security.rs
git commit -m "refactor: add i18n support to scan_all_installed_skills command"
```

---

## Task 8: 修改测试代码

**Files:**
- Modify: `src-tauri/src/security/scanner.rs` (测试部分)

**Step 1: 修改所有测试中的 scan_file 调用**

在 `#[cfg(test)]` 模块中，找到所有 `scanner.scan_file()` 调用，添加 locale 参数 `"zh"`。

例如，test_hard_trigger_patterns（约第 353 行）：

```rust
// 修改前
let report = scanner.scan_file(malicious_content, "test.md").unwrap();

// 修改后
let report = scanner.scan_file(malicious_content, "test.md", "zh").unwrap();
```

对以下测试应用相同修改：
- test_hard_trigger_patterns (line ~353)
- test_reverse_shell_detection (line ~380)
- test_curl_pipe_sh_detection (line ~398)
- test_api_key_detection (line ~420)
- test_private_key_detection (line ~443)
- test_safe_skill (line ~472)
- test_medium_risk_skill (line ~496)
- test_aws_credentials_detection (line ~553)
- test_eval_detection (line ~567)

以及 test_weighted_scoring 中的两处调用（约第 536、537 行）。

**Step 2: 运行测试验证**

```bash
cd src-tauri && cargo test
```

预期：所有测试通过

**Step 3: 提交**

```bash
git add src-tauri/src/security/scanner.rs
git commit -m "test: update scanner tests to use locale parameter"
```

---

## Task 9: 更新前端调用 - scan_skill_archive

**Files:**
- Modify: `src/components/MarketplacePage.tsx`

**Step 1: 在 MarketplacePage.tsx 中导入 i18n**

在文件顶部的 import 部分添加：

```typescript
import i18n from '../i18n/config';
```

**Step 2: 找到 scan_skill_archive 调用并添加 locale 参数**

找到 `invoke('scan_skill_archive')` 调用（使用 Grep 搜索），添加 locale 参数：

```typescript
// 修改前
const report = await invoke<SecurityReport>('scan_skill_archive', {
  archivePath: skillMdPath,
});

// 修改后
const report = await invoke<SecurityReport>('scan_skill_archive', {
  archivePath: skillMdPath,
  locale: i18n.language,
});
```

**Step 3: 验证前端编译**

```bash
pnpm typecheck
```

**Step 4: 提交**

```bash
git add src/components/MarketplacePage.tsx
git commit -m "feat: pass locale to scan_skill_archive in frontend"
```

---

## Task 10: 更新前端调用 - scan_all_installed_skills

**Files:**
- Modify: `src/components/OverviewPage.tsx`
- Modify: `src/components/SecurityDashboard.tsx`

**Step 1: 在 OverviewPage.tsx 中导入 i18n**

在文件顶部添加：

```typescript
import i18n from '../i18n/config';
```

**Step 2: 找到 scan_all_installed_skills 调用并添加 locale**

找到 `invoke('scan_all_installed_skills')` 调用，修改为：

```typescript
// 修改前
const results = await invoke<SkillScanResult[]>('scan_all_installed_skills');

// 修改后
const results = await invoke<SkillScanResult[]>('scan_all_installed_skills', {
  locale: i18n.language,
});
```

**Step 3: 在 SecurityDashboard.tsx 中应用相同修改**

重复步骤 1 和步骤 2。

**Step 4: 验证前端编译**

```bash
pnpm typecheck
```

**Step 5: 提交**

```bash
git add src/components/OverviewPage.tsx src/components/SecurityDashboard.tsx
git commit -m "feat: pass locale to scan_all_installed_skills in frontend"
```

---

## Task 11: 最终测试和验证

**Step 1: 完整构建测试**

```bash
# 后端测试
cd src-tauri && cargo test

# 前端类型检查
cd .. && pnpm typecheck

# 完整构建
pnpm build
```

预期：所有测试通过，构建成功

**Step 2: 手动功能测试清单**

启动应用：
```bash
pnpm dev
```

测试项目：
- [ ] 中文模式下扫描技能，查看安全报告是否显示中文
- [ ] 切换到英文，重新扫描，查看报告是否显示英文
- [ ] 测试高风险技能的阻止消息
- [ ] 测试中等风险技能的警告消息
- [ ] 测试安全技能的通过消息

**Step 3: 最终提交**

```bash
git add -A
git commit -m "feat: complete backend i18n implementation

- Add rust-i18n dependency and configuration
- Create translation files for security and common modules
- Refactor scanner.rs to use i18n
- Update all Tauri commands to accept locale parameter
- Update frontend to pass locale when calling backend
- All tests passing

Closes: backend i18n implementation
"
```

---

## 完成

所有任务完成后，后端将完全支持中英文双语，无任何硬编码字符串。
